<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenClaw Remote</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { width: 320px; font-family: -apple-system, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; }
        h1 { font-size: 14px; text-align: center; margin-bottom: 15px; }
        .status { text-align: center; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 12px; }
        .status.connected { background: rgba(102, 187, 106, 0.3); }
        .status.waiting { background: rgba(255, 193, 7, 0.3); }
        .card { background: white; border-radius: 10px; padding: 12px; margin-bottom: 10px; color: #333; }
        .card h3 { font-size: 12px; color: #667eea; margin-bottom: 10px; }
        .input-group { margin-bottom: 8px; }
        .input-group label { display: block; font-size: 10px; color: #666; margin-bottom: 4px; }
        .input-group input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 12px; }
        .btn { width: 100%; padding: 10px; border: none; border-radius: 8px; font-size: 12px; cursor: pointer; margin-bottom: 5px; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-secondary { background: #f5f5f5; color: #333; }
        .quick { display: flex; flex-wrap: wrap; gap: 5px; }
        .quick button { padding: 5px 10px; font-size: 10px; background: #f0f0f0; border: none; border-radius: 4px; cursor: pointer; }
        .quick button:hover { background: #667eea; color: white; }
        .log { background: #1e1e1e; color: #00ff00; padding: 8px; border-radius: 6px; font-family: monospace; font-size: 10px; max-height: 80px; overflow-y: auto; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>ğŸ¤– OpenClaw Remote</h1>
    
    <div class="status waiting" id="status">ğŸ”„ ç­‰å¾…è¿æ¥æœåŠ¡å™¨...</div>
    
    <div class="card">
        <h3>ğŸ”— æœåŠ¡å™¨é…ç½®</h3>
        <div class="input-group">
            <input type="text" id="server-url" placeholder="http://localhost:9999">
        </div>
        <button class="btn btn-primary" id="connect-btn">è¿æ¥æœåŠ¡å™¨</button>
        <button class="btn btn-secondary" id="disconnect-btn" style="display:none;">æ–­å¼€</button>
    </div>
    
    <div class="card">
        <h3>ğŸ“Š å¿«æ·æ“ä½œ</h3>
        <div class="quick">
            <button onclick="sendQuick('navigate', 'https://www.10jqka.com.cn')">åŒèŠ±é¡º</button>
            <button onclick="sendQuick('navigate', 'https://quote.eastmoney.com')">ä¸œæ–¹è´¢å¯Œ</button>
            <button onclick="sendQuick('getStockData')">è‚¡ç¥¨</button>
            <button onclick="sendQuick('getPageInfo')">é¡µé¢</button>
        </div>
    </div>
    
    <div class="card">
        <h3>ğŸ“‹ æ‰§è¡Œæ—¥å¿—</h3>
        <div class="log" id="log">ç­‰å¾…...</div>
    </div>

    <script>
        let serverUrl = null;
        let polling = false;
        let lastCmdId = null;
        
        async function connect() {
            serverUrl = document.getElementById('server-url').value.trim();
            if (!serverUrl) {
                log('è¯·è¾“å…¥æœåŠ¡å™¨åœ°å€');
                return;
            }
            
            // ä¿å­˜é…ç½®
            await chrome.storage.local.set({ serverUrl });
            
            log('è¿æ¥ä¸­...');
            updateStatus('waiting');
            
            // å¼€å§‹è½®è¯¢
            polling = true;
            poll();
            
            document.getElementById('connect-btn').style.display = 'none';
            document.getElementById('disconnect-btn').style.display = 'block';
            updateStatus('connected');
            log('âœ… å·²è¿æ¥: ' + serverUrl);
        }
        
        function disconnect() {
            polling = false;
            document.getElementById('connect-btn').style.display = 'block';
            document.getElementById('disconnect-btn').style.display = 'none';
            updateStatus('waiting');
            log('å·²æ–­å¼€è¿æ¥');
        }
        
        async function poll() {
            while (polling) {
                try {
                    // è·å–å‘½ä»¤
                    const url = serverUrl + '/poll?id=' + (lastCmdId || '');
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    if (data.command && data.id) {
                        log('ğŸ“ æ‰§è¡Œå‘½ä»¤: ' + data.command.type);
                        
                        // æ‰§è¡Œå‘½ä»¤
                        const result = await chrome.runtime.sendMessage({
                            action: 'execute',
                            command: data.command
                        });
                        
                        // æŠ¥å‘Šç»“æœ
                        lastCmdId = data.id;
                        await fetch(serverUrl + '/result', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ id: data.id, result: result })
                        });
                        
                        log('âœ… å®Œæˆ: ' + data.command.type);
                    }
                } catch (e) {
                    // å¿½ç•¥é”™è¯¯ï¼Œç»§ç»­è½®è¯¢
                }
                
                await new Promise(r => setTimeout(r, 1000)); // æ¯ç§’è½®è¯¢
            }
        }
        
        async function sendQuick(type, param) {
            if (!serverUrl) {
                log('è¯·å…ˆè¿æ¥æœåŠ¡å™¨');
                return;
            }
            
            const command = { type };
            if (param) {
                if (type === 'navigate') command.url = param;
                else command.selector = param;
            }
            
            try {
                const response = await fetch(serverUrl + '/command', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ command })
                });
                
                const data = await response.json();
                if (data.success) {
                    log('ğŸ“¤ å·²å‘é€: ' + type);
                }
            } catch (e) {
                log('âŒ å‘é€å¤±è´¥: ' + e.message);
            }
        }
        
        function updateStatus(status) {
            const el = document.getElementById('status');
            if (status === 'connected') {
                el.className = 'status connected';
                el.textContent = 'ğŸŸ¢ å·²è¿æ¥';
            } else {
                el.className = 'status waiting';
                el.textContent = 'ğŸ”„ ' + status;
            }
        }
        
        function log(msg) {
            const el = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            el.textContent = '[' + time + '] ' + msg;
        }
        
        // åˆå§‹åŒ–
        (async function init() {
            const config = await chrome.storage.local.get(['serverUrl']);
            if (config.serverUrl) {
                document.getElementById('server-url').value = config.serverUrl;
                serverUrl = config.serverUrl;
                connect();
            }
            
            document.getElementById('connect-btn').addEventListener('click', connect);
            document.getElementById('disconnect-btn').addEventListener('click', disconnect);
        })();
    </script>
</body>
</html>
